<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DZT Knowledge Graph – Suche</title>
  <style>
* { margin:0; padding:0; box-sizing:border-box; font-family:"Arial",sans-serif; color:#fff; }
body { display:flex; flex-direction:column; align-items:center; min-height:100vh; width:100%; padding:0;
  background:linear-gradient(to right,#001f3d,#00274d); color:#fff; }
h1 { font-size:26px; margin:20px 0 10px; }
.container { background:rgba(255,255,255,.12); padding:30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.4);
  text-align:left; max-width:1000px; width:100%; margin:20px auto; }
button { padding:10px 16px; background:#009688; color:#fff; border:none; border-radius:6px; cursor:pointer; margin:6px; transition:background .2s; }
button:hover{background:#00796b} button:disabled{background:#555; cursor:default}
input[type="text"]{width:100%; padding:10px 14px; margin:12px 0; background:rgba(255,255,255,.2); color:#fff; border:none; border-radius:6px;}
.form-grid { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end; }
#results { margin-top:16px; display:grid; gap:12px; }
.result { display:grid; grid-template-columns:140px 1fr; gap:14px; padding:12px; border:1px solid rgba(255,255,255,.25); border-radius:10px; background:rgba(0,0,0,.25); }
.thumb { width:140px; height:100px; border-radius:8px; overflow:hidden; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.25);
  display:grid; place-items:center; font-size:12px; color:#d0e6ff; }
.thumb img { width:100%; height:100%; object-fit:cover; display:block; }
.meta { display:grid; gap:6px; }
.title { font-size:18px; font-weight:700; }
.line a { color:#9effb0; text-decoration:none; }
.toolbar { display:flex; align-items:center; justify-content:space-between; margin-top:8px; }
.count, #status { color:#e0e0e0; font-size:13px; }
.spinner { display:inline-block; width:16px; height:16px; border-radius:50%; border:3px solid rgba(255,255,255,.35); border-top-color:#00d1ff; animation:spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Menü-Stile */
.menu-container {
  display:flex;
  align-items:center;
  justify-content:flex-start;
  background:rgba(255,255,255,.1);
  width:100%;
  padding:10px 20px;
  gap:20px;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
}
.logo {
  height:36px;
  margin-right:20px;
}
.menu-links {
  display:flex;
  align-items:center;
  gap:20px;
}
.menu-item {
  display:flex;
  align-items:center;
  gap:6px;
  color:#fff;
  text-decoration:none;
  font-size:15px;
}
.menu-item:hover .menu-text {
  text-decoration:underline;
}
.menu-icon {
  font-size:20px;
  vertical-align:middle;
}
  </style>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

  <!-- ======== Menü ======== -->
  <nav class="menu-container">
    <img class="logo" src="../SaTourN-RGB.png" alt="SaTourN Logo">
    <div class="menu-links">
      <a href="../Statistik/index.html" class="menu-item">
        <span class="material-icons menu-icon">bar_chart</span>
        <div class="menu-text">Statistik</div>
      </a>
      <a href="../Pages-Builder/index.html" class="menu-item">
        <span class="material-icons menu-icon">build</span>
        <div class="menu-text">Pages Builder</div>
      </a>
      <a href="../KG-Finder/index.html" class="menu-item">
        <span class="material-icons menu-icon">hub</span>
        <div class="menu-text">Knowledge Graphen</div>
      </a>
    </div>
  </nav>

  <div class="header">
    <h1>DZT Knowledge Graph – Suche</h1>
  </div>

  <section class="container">
    <form id="searchForm">
      <div class="form-grid">
        <div>
          <label for="q">Suchbegriff</label>
          <input id="q" type="text" placeholder="z. B. Dresden, Museum, Striezelmarkt…" />
        </div>
        <div style="display:flex; gap:8px;">
          <button id="resetBtn" type="button">Zurücksetzen</button>
          <button id="searchBtn" type="submit">Suchen</button>
        </div>
      </div>
    </form>

    <div class="toolbar">
      <div>
        <button id="prevBtn" disabled>◀︎ Zurück</button>
        <button id="nextBtn" disabled>Weiter ▶︎</button>
        <span class="count" id="count"></span>
      </div>
      <div id="status" class="count"></div>
    </div>

    <main id="results"></main>
  </section>

  <template id="resultTpl">
    <article class="result">
      <div class="thumb" data-role="thumb"><span>kein Bild</span></div>
      <div class="meta">
        <div class="title" data-role="title">—</div>
        <div class="line">Kategorie: <span data-role="cat">—</span></div>
        <div class="line">Seite: <a data-role="id" href="#" target="_blank" rel="noopener">—</a></div>
      </div>
    </article>
  </template>

  <!-- ==================== Skript ==================== -->
  <script>
/* ==========================
   Konfiguration
========================== */
const API_KEY     = '3b49f5e2f44665aec87f761d4cafb9d2';     // dein öffentlicher Key
const DS_LIST_URL = 'https://semantify.it/list/CRkyvcqGqeUu';
const FIXED_LANG  = 'de';
const PAGE_SIZE   = 10;

/* ==========================
   State & DOM
========================== */
let page = 1;
let lastQuery = '';

const form     = document.getElementById('searchForm');
const inputQ   = document.getElementById('q');
const results  = document.getElementById('results');
const tpl      = document.getElementById('resultTpl');
const prevBtn  = document.getElementById('prevBtn');
const nextBtn  = document.getElementById('nextBtn');
const countEl  = document.getElementById('count');
const statusEl = document.getElementById('status');
const resetBtn = document.getElementById('resetBtn');

(function init() {
  prevBtn.addEventListener('click', () => { if (page>1) { page--; search(lastQuery); } });
  nextBtn.addEventListener('click', () => { page++; search(lastQuery); });
  resetBtn.addEventListener('click', () => { inputQ.value=''; page=1; results.innerHTML=''; countEl.textContent=''; status(''); });
  form.addEventListener('submit', (e) => { e.preventDefault(); page=1; lastQuery=inputQ.value.trim(); search(lastQuery); });
})();

/* ==========================
   UI/Helpers
========================== */
function status(msg, isError=false){ statusEl.innerHTML = msg ? (isError?`<span style="color:#ff6b6b">${msg}</span>`:msg) : ''; }
function getFirstProp(obj, keys){
  if (!obj || typeof obj !== 'object') return undefined;
  for (const k of keys) {
    if (Object.prototype.hasOwnProperty.call(obj, k)) return obj[k];
    const hit = Object.keys(obj).find(key =>
      key.endsWith('/' + k.split(':').pop()) || key.endsWith('#' + k.split(':').pop()) || key === k
    );
    if (hit) return obj[hit];
  }
  return undefined;
}
function pickLangString(value){
  if (!value) return '';
  const pick = v => typeof v === 'string' ? v : (v?.['@value'] || v?.value || '');
  if (Array.isArray(value)) {
    const byLang = value.find(v => v && (v['@language']===FIXED_LANG || v['language']===FIXED_LANG)); if (byLang) return pick(byLang);
    const de     = value.find(v => v && (v['@language']==='de'       || v['language']==='de'      )); if (de) return pick(de);
    const any    = value.find(v => v && (v['@value'] || v['value'])); return any ? pick(any) : (typeof value[0]==='string' ? value[0] : '');
  }
  if (typeof value === 'object') return value['@value'] || value['value'] || '';
  return typeof value === 'string' ? value : '';
}
function selectPrimaryNode(data, uri){
  if (!data) return null;
  if (Array.isArray(data)) {
    const byId = data.find(n => n && (n['@id']===uri || n['@id']===decodeURIComponent(uri)));
    return byId || data.find(n => n && n['@type']) || data[0];
  }
  if (Array.isArray(data['@graph'])) {
    const exact = data['@graph'].find(n => n && (n['@id']===uri || n['@id']===decodeURIComponent(uri)));
    return exact || data['@graph'].find(n => n && n['@type']) || data['@graph'][0];
  }
  return data;
}
function indexGraph(data){
  const map = new Map();
  const push = n => { if (n && typeof n==='object' && typeof n['@id']==='string') map.set(n['@id'], n); };
  if (Array.isArray(data)) data.forEach(push);
  if (Array.isArray(data['@graph'])) data['@graph'].forEach(push);
  else if (data && typeof data==='object') push(data);
  return map;
}
function fallbackTitleFromUri(uri){
  try { const last = uri.split(/[/#]/).pop() || uri; return decodeURIComponent(last).replace(/[-_]/g, ' '); }
  catch { return uri; }
}

/* ==========================
   Bild-Auflösung aus ImageObject
========================== */

// Prüft, ob die übergebene URL eine Onlim-Entity ist (z. B. http://onlim.com/entity/<uuid>)
function isOnlimEntityUrl(u){
  try { const x=new URL(u); return /(^|\.)onlim\.com$/i.test(x.hostname) && /^\/entity\/[a-f0-9-]+/i.test(x.pathname); }
  catch { return false; }
}

// Lädt das Onlim-ImageObject über /v1/kg/things/{id}?ns=... und liest schema:contentUrl["@value"]
async function loadImageObjectContentUrl(onlimEntityUrl){
  try{
    const u = new URL(onlimEntityUrl);
    const id = u.pathname.split('/').pop();
    const ns = `${u.protocol}//${u.host}/entity`;
    const url = new URL(`https://proxy.opendatagermany.io/api/ts/v1/kg/things/${encodeURIComponent(id)}`);
    url.searchParams.set('ns', ns);
    const res = await fetch(url.toString(), {
      headers: { 'x-api-key': API_KEY, 'accept': 'application/json' }
    });
    if (!res.ok) return '';

    const data = await res.json();
    const arr  = Array.isArray(data) ? data : (Array.isArray(data['@graph']) ? data['@graph'] : [data]);
    const imgNode = arr.find(n => n && typeof n==='object') || {};

    const cu = imgNode['https://schema.org/contentUrl'] || imgNode['http://schema.org/contentUrl'] || imgNode['contentUrl'];
    // cu kann ein Objekt { "@value": "https://..." } oder String oder Array sein
    const toStr = (v) => Array.isArray(v) ? (typeof v[0]==='string' ? v[0] : (v[0]?.['@value'] || v[0]?.['value'] || '')) :
                    (typeof v==='string' ? v : (v?.['@value'] || v?.['value'] || ''));
    const contentUrl = toStr(cu);
    if (contentUrl) return contentUrl;

    const urlProp = imgNode['https://schema.org/url'] || imgNode['url'];
    const fallback = toStr(urlProp);
    return fallback || '';
  } catch {
    return '';
  }
}

// Extrahiert aus dem Thing-Node den ersten Bild-Kandidaten (image/thumbnailUrl/photo/logo/…),
// lädt bei Onlim-IDs das ImageObject und gibt die echte Bild-URL (contentUrl) zurück.
async function resolveImageUrlFromThing(thingUri, node, graphMap){
  const originFromThing = (uri)=>{ try{ const u=new URL(uri); return `${u.protocol}//${u.host}`; } catch{ return ''; } };
  const origin = originFromThing(thingUri || '');

  // Macht aus beliebigen Values (String/Objekt/Array) einen String, wenn möglich.
  const asStr = (x)=> {
    if (!x) return '';
    if (typeof x==='string') return x;
    if (typeof x==='object') {
      if (x['@id']) return x['@id'];
      if (x['@value'] || x['value']) return x['@value'] || x['value'];
    }
    return '';
  };

  // Liest contentUrl/url/@id aus einem möglichen ImageObject-Knoten
  const fromImageLikeNode = async (imgVal) => {
    if (!imgVal) return '';
    // Direkt-URL?
    const direct = asStr(imgVal);
    if (/^https?:\/\//i.test(direct)) {
      if (isOnlimEntityUrl(direct)) {
        return await loadImageObjectContentUrl(direct);
      }
      return direct;
    }
    // Wenn @id auf einen Knoten zeigt, versuche im GraphMap
    const id = (typeof imgVal==='object' && imgVal['@id']) ? imgVal['@id'] : '';
    if (id) {
      if (/^https?:\/\//i.test(id)) {
        if (isOnlimEntityUrl(id)) {
          return await loadImageObjectContentUrl(id);
        }
        return id;
      }
      if (graphMap && graphMap.has(id)) {
        const imgNode = graphMap.get(id);
        const cu = imgNode['https://schema.org/contentUrl'] || imgNode['http://schema.org/contentUrl'] || imgNode['contentUrl'];
        const u2 = imgNode['https://schema.org/url'] || imgNode['url'];
        const toStr = v => Array.isArray(v) ? (typeof v[0]==='string' ? v[0] : (v[0]?.['@value']||v[0]?.['value']||'')) :
                           (typeof v==='string' ? v : (v?.['@value']||v?.['value']||''));
        return toStr(cu) || toStr(u2) || '';
      }
    }
    return '';
  };

  // Kandidatenfelder am Thing
  const propLists = [
    ['https://schema.org/image','http://schema.org/image','image'],
    ['https://schema.org/thumbnailUrl','http://schema.org/thumbnailUrl','thumbnailUrl'],
    ['https://schema.org/photo','photo'],
    ['https://schema.org/logo','logo'],
    ['https://schema.org/hasRepresentation','hasRepresentation'],
    ['https://schema.org/depiction','depiction']
  ];

  // Nacheinander prüfen
  for (const props of propLists) {
    const hitKey = Object.keys(node||{}).find(k => props.includes(k) || props.some(p => k.endsWith('/'+p) || k.endsWith('#'+p)));
    if (!hitKey) continue;

    const val = node[hitKey];
    if (Array.isArray(val)) {
      for (const v of val) {
        const url = await fromImageLikeNode(v);
        if (url) return url;
      }
    } else {
      const url = await fromImageLikeNode(val);
      if (url) return url;
    }
  }
  return '';
}

/* ==========================
   API Calls (direkt)
========================== */
async function queryThings({ kw }) {
  const url = new URL('https://proxy.opendatagermany.io/api/ts/v2/kg/things');
  if (kw) url.searchParams.set('kw', kw);
  url.searchParams.set('filterDsList', DS_LIST_URL);

  const res = await fetch(url.toString(), {
    headers: {
      'x-api-key': API_KEY,
      'accept': 'application/json',
      'inLang': FIXED_LANG,
      'page': String(page),
      'page-size': String(PAGE_SIZE)
    }
  });
  if (!res.ok) throw new Error(`Suche fehlgeschlagen (${res.status})`);
  const data = await res.json();
  const items = Array.isArray(data) ? data
             : Array.isArray(data?.data) ? data.data
             : Array.isArray(data?.items) ? data.items
             : Array.isArray(data?.results) ? data.results
             : [];
  return items;
}

async function fetchThingById(uri) {
  if (!uri) return null;
  const p  = Math.max(uri.lastIndexOf('/'), uri.lastIndexOf('#'));
  const ns = uri.substring(0, p);
  const id = uri.substring(p + 1);
  const url = new URL(`https://proxy.opendatagermany.io/api/ts/v1/kg/things/${encodeURIComponent(id)}`);
  url.searchParams.set('ns', ns);

  const res = await fetch(url.toString(), {
    headers: { 'x-api-key': API_KEY, 'accept': 'application/json', 'inLang': FIXED_LANG, 'x-hop': '3' }
  });
  if (!res.ok) throw new Error(`Abruf fehlgeschlagen (${res.status})`);
  const data = await res.json();
  return { uri, data };
}

/* ==========================
   Suche & Rendering
========================== */
async function search(query){
  results.innerHTML = '';
  status(`<span class="spinner"></span> Lädt…`);
  prevBtn.disabled = true; nextBtn.disabled = true; countEl.textContent = '';

  try {
    let things = await queryThings({ kw: query });
    if (!things.length && query) { things = await queryThings({ kw: query }); } // kleiner Retry

    if (!things.length) { status('Keine Treffer. Begriff ändern.'); return; }

    const detailed = await Promise.all(things.map(t => fetchThingById(t['@id']).catch(() => null)));
    detailed.filter(Boolean).forEach(renderItem);

    status(`${things.length} Treffer.`);
    prevBtn.disabled = page === 1;
    nextBtn.disabled = things.length < PAGE_SIZE;
    countEl.textContent = `Seite ${page}`;
  } catch (err) {
    console.error(err);
    status(err.message || 'Unerwarteter Fehler', true);
  }
}

function makeKbrLandingUrl(thingUri) {
  const u = new URL('https://app.opendatagermany.io/kbr/landingpage');
  u.searchParams.set('kbr-entity', thingUri);
  u.searchParams.set('lang', FIXED_LANG);
  return u.toString();
}

async function renderItem(entry){
  const { uri, data } = entry;
  const node = selectPrimaryNode(data, uri) || data || {};
  const graphMap = indexGraph(data);
  const el = tpl.content.firstElementChild.cloneNode(true);

  // Titel
  const nameVal = getFirstProp(node, ['https://schema.org/name','http://schema.org/name','schema:name','name','rdfs:label']);
  const name = pickLangString(nameVal) || fallbackTitleFromUri(uri);
  el.querySelector('[data-role=title]').textContent = name || 'Ohne Titel';

  // Kategorie
  let cat = '';
  const typesNode = Array.isArray(node['@type']) ? node['@type'] : (node['@type'] ? [node['@type']] : []);
  if (typesNode.length) {
    cat = typesNode.map(t => (typeof t==='string' ? t : (t['@id'] || '')))
                   .map(t => t.split(/[#/]/).pop())
                   .filter(Boolean).join(', ');
  } else {
    const catVal = getFirstProp(node, ['https://schema.org/category','http://schema.org/category','schema:category','category']);
    cat = pickLangString(catVal) || '';
  }
  el.querySelector('[data-role=cat]').textContent = cat || '—';

  // Landingpage-Link
  const landing = makeKbrLandingUrl(uri);
  const a = el.querySelector('[data-role=id]');
  a.href = landing; a.textContent = landing;

  // Bild (ImageObject → contentUrl["@value"])
  const thumb = el.querySelector('[data-role=thumb]');
  try {
    const imgUrl = await resolveImageUrlFromThing(uri, node, graphMap);
    if (imgUrl) {
      const img = new Image();
      img.alt = name || 'Bild'; img.loading = 'lazy'; img.decoding='async';
      img.onload = ()=>{ thumb.innerHTML=''; thumb.appendChild(img); };
      img.onerror = ()=>{ thumb.innerHTML = `<a href="${landing}" target="_blank" rel="noopener">Bild öffnen</a>`; };
      img.src = imgUrl;
    } else {
      thumb.innerHTML = `<a href="${landing}" target="_blank" rel="noopener">Bild öffnen</a>`;
    }
  } catch {
    thumb.innerHTML = `<a href="${landing}" target="_blank" rel="noopener">Bild öffnen</a>`;
  }

  results.appendChild(el);
}

// Events (redundant mit init, aber klar ersichtlich)
document.getElementById('searchForm').addEventListener('submit', (e) => {
  e.preventDefault();
  page = 1;
  search(document.getElementById('q').value.trim());
});
document.getElementById('prevBtn').addEventListener('click', () => { if (page>1) { page--; search(document.getElementById('q').value.trim()); } });
document.getElementById('nextBtn').addEventListener('click', () => { page++; search(document.getElementById('q').value.trim()); });

</script>
</body>
</html>
