<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DZT Knowledge Graph – Suche</title>
  <style>
/* === styles_trimmed.css (relevant) === */
* { margin:0; padding:0; box-sizing:border-box; font-family:"Arial",sans-serif; color:#fff; }
body { display:flex; flex-direction:column; align-items:center; min-height:100vh; width:100%; padding:20px;
  background:linear-gradient(to right,#001f3d,#00274d); color:#fff; }
.container { background:rgba(255,255,255,.12); padding:30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.4);
  text-align:left; max-width:1000px; width:100%; margin:20px auto; }
h1 { font-size:26px; margin-bottom:10px; }
button { padding:10px 16px; background:#009688; color:#fff; border:none; border-radius:6px; cursor:pointer; margin:6px; transition:background .2s; }
button:hover{background:#00796b} button:disabled{background:#555; cursor:default}
input[type="text"]{width:100%; padding:10px 14px; margin:12px 0; background:rgba(255,255,255,.2); color:#fff; border:none; border-radius:6px;}
.header { width:100%; max-width:1000px; margin-top:10px; }
.form-grid { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end; }
#results { margin-top:16px; display:grid; gap:12px; }
.result { display:grid; grid-template-columns:140px 1fr; gap:14px; padding:12px; border:1px solid rgba(255,255,255,.25); border-radius:10px; background:rgba(0,0,0,.25); }
.thumb { width:140px; height:100px; border-radius:8px; overflow:hidden; background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.25);
  display:grid; place-items:center; font-size:12px; color:#d0e6ff; }
.thumb img { width:100%; height:100%; object-fit:cover; display:block; }
.meta { display:grid; gap:6px; }
.title { font-size:18px; font-weight:700; }
.line a { color:#9effb0; text-decoration:none; }
.toolbar { display:flex; align-items:center; justify-content:space-between; margin-top:8px; }
.count, #status { color:#e0e0e0; font-size:13px; }
.spinner { display:inline-block; width:16px; height:16px; border-radius:50%; border:3px solid rgba(255,255,255,.35); border-top-color:#00d1ff; animation:spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="header">
    <h1>DZT Knowledge Graph – Suche</h1>
    <p class="sub">Suche im Knowledge Graph der DZT. Ergebnisliste zeigt <strong>Titel</strong>, <strong>Kategorie</strong> und <strong>Bild</strong>.</p>
  </div>

  <section class="container">
    <form id="searchForm">
      <div class="form-grid">
        <div>
          <label for="q">Suchbegriff</label>
          <input id="q" type="text" placeholder="z. B. Dresden, Museum, Striezelmarkt…" />
        </div>
        <div style="display:flex; gap:8px;">
          <button id="resetBtn" type="button">Zurücksetzen</button>
          <button id="searchBtn" type="submit">Suchen</button>
        </div>
      </div>
    </form>

    <div class="toolbar">
      <div>
        <button id="prevBtn" disabled>◀︎ Zurück</button>
        <button id="nextBtn" disabled>Weiter ▶︎</button>
        <span class="count" id="count"></span>
      </div>
      <div id="status" class="count"></div>
    </div>

    <main id="results"></main>
  </section>

  <template id="resultTpl">
    <article class="result">
      <div class="thumb" data-role="thumb"><span>kein Bild</span></div>
      <div class="meta">
        <div class="title" data-role="title">—</div>
        <div class="line">Kategorie: <span data-role="cat">—</span></div>
        <div class="line">ID: <a data-role="id" href="#" target="_blank" rel="noopener">—</a></div>
      </div>
    </article>
  </template>

  <script>
    // ==== Konfiguration ====
    const API_KEY = '3b49f5e2f44665aec87f761d4cafb9d2'; // öffentlicher Key (vom Nutzer freigegeben)
    const DS_LIST_URL = 'https://semantify.it/list/CRkyvcqGqeUu';
    const FIXED_LANG = 'de';

    // ==== State & DOM ====
    let page = 1;
    const PAGE_SIZE = 10;

    const form = document.getElementById('searchForm');
    const inputQ = document.getElementById('q');
    const results = document.getElementById('results');
    const tpl = document.getElementById('resultTpl');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const countEl = document.getElementById('count');
    const statusEl = document.getElementById('status');
    const resetBtn = document.getElementById('resetBtn');

    (function init() {
      prevBtn.addEventListener('click', () => { if (page>1) { page--; search(inputQ.value.trim()); } });
      nextBtn.addEventListener('click', () => { page++; search(inputQ.value.trim()); });
      resetBtn.addEventListener('click', () => { inputQ.value=''; page=1; results.innerHTML=''; countEl.textContent=''; status(''); });
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        page = 1;
        search(inputQ.value.trim());
      });
    })();

    // ==== UI/Helper ====
    function status(msg, isError=false) { statusEl.innerHTML = msg ? (isError ? `<span style="color:#ff6b6b">${msg}</span>` : msg) : ''; }
    function getFirstProp(obj, keys) {
      if (!obj || typeof obj !== 'object') return undefined;
      for (const k of keys) {
        if (Object.prototype.hasOwnProperty.call(obj, k)) return obj[k];
        const hit = Object.keys(obj).find(key =>
          key.endsWith('/' + k.split(':').pop()) || key.endsWith('#' + k.split(':').pop()) || key === k
        ); if (hit) return obj[hit];
      } return undefined;
    }
    function pickLangString(value) {
      if (!value) return '';
      const lang = FIXED_LANG;
      const pick = (v)=> typeof v==='string' ? v : (v?.['@value'] || v?.value || '');
      if (Array.isArray(value)) {
        const byLang = value.find(v => v && (v['@language'] === lang || v['language'] === lang)); if (byLang) return pick(byLang);
        const de = value.find(v => v && (v['@language'] === 'de' || v['language'] === 'de')); if (de) return pick(de);
        const any = value.find(v => v && (v['@value'] || v['value'])); return any ? pick(any) : (typeof value[0] === 'string' ? value[0] : '');
      }
      if (typeof value === 'object') return value['@value'] || value['value'] || '';
      return typeof value === 'string' ? value : '';
    }
    function selectPrimaryNode(data, uri) {
      if (!data) return null;
      if (Array.isArray(data)) { const byId = data.find(n => n && (n['@id'] === uri || n['@id'] === decodeURIComponent(uri))); return byId || data.find(n => n && n['@type']) || data[0]; }
      if (data && Array.isArray(data['@graph'])) {
        const exact = data['@graph'].find(n => n && (n['@id'] === uri || n['@id'] === decodeURIComponent(uri)));
        if (exact) return exact; const firstThing = data['@graph'].find(n => n && n['@type']); return firstThing || data['@graph'][0];
      } return data;
    }
    function fallbackTitleFromUri(uri) { try { const last = uri.split(/[/#]/).pop() || uri; return decodeURIComponent(last).replace(/[-_]/g, ' '); } catch { return uri; } }
    function indexGraph(data) {
      const map = new Map();
      if (!data) return map;
      const push = (n)=> { if (n && typeof n==='object' && typeof n['@id']==='string') map.set(n['@id'], n); };
      if (Array.isArray(data)) data.forEach(push);
      if (Array.isArray(data['@graph'])) data['@graph'].forEach(push);
      else if (data && typeof data==='object') push(data);
      return map;
    }

    // === Bild-URL-Tools ===
    function absoluteFromOriginMaybe(u, origin) {
      if (!u || typeof u !== 'string') return '';
      if (/^https?:\/\//i.test(u)) return u;
      if (u.startsWith('//')) return 'https:' + u;
      if (u.startsWith('/')) return origin.replace(/\/+$/,'') + u;
      return '';
    }
    function getOriginFromUri(uri) { try { const u = new URL(uri); return `${u.protocol}//${u.host}`; } catch { return ''; } }

    function extractUrlFromImage(img, origin, graphMap) {
      const read = (v) => {
        if (!v) return '';
        if (typeof v === 'string') {
          const abs = absoluteFromOriginMaybe(v, origin);
          if (abs) return abs;
          if (graphMap && graphMap.has(v)) return read(graphMap.get(v));
          return '';
        }
        const cu = v['https://schema.org/contentUrl'] || v['http://schema.org/contentUrl'] || v['schema:contentUrl'] || v['contentUrl'];
        if (cu) {
          const raw = Array.isArray(cu)
            ? (typeof cu[0] === 'string' ? cu[0] : (cu[0]?.['@value'] || cu[0]?.['value'] || ''))
            : (typeof cu === 'string' ? cu : (cu['@value'] || cu['value'] || ''));
          const abs = absoluteFromOriginMaybe(raw, origin); if (abs) return abs;
          if (graphMap && graphMap.has(raw)) return read(graphMap.get(raw));
          return '';
        }
        const u2 = v['url'];
        if (u2) {
          const raw = Array.isArray(u2)
            ? (typeof u2[0] === 'string' ? u2[0] : (u2[0]?.['@value'] || u2[0]?.['value'] || ''))
            : (typeof u2 === 'string' ? u2 : (u2?.['@value'] || u2?.['value'] || ''));
          const abs = absoluteFromOriginMaybe(raw, origin); if (abs) return abs;
          if (graphMap && graphMap.has(raw)) return read(graphMap.get(raw));
          return '';
        }
        const id = v['@id'];
        if (id && typeof id === 'string') {
          const abs = absoluteFromOriginMaybe(id, origin); if (abs) return abs;
          if (graphMap && graphMap.has(id)) return read(graphMap.get(id));
        }
        return '';
      };
      if (Array.isArray(img)) { for (const n of img) { const u = read(n); if (u) return u; } return ''; }
      return read(img);
    }

    function pickImageUrl(node, thingUri, graphMap) {
      const origin = getOriginFromUri(thingUri || '');
      const propsList = [
        ['https://schema.org/image','http://schema.org/image','schema:image','image'],
        ['https://schema.org/thumbnailUrl','http://schema.org/thumbnailUrl','schema:thumbnailUrl','thumbnailUrl'],
        ['https://schema.org/photo','http://schema.org/photo','schema:photo','photo'],
        ['https://schema.org/logo','http://schema.org/logo','schema:logo','logo'],
        ['https://schema.org/hasRepresentation','http://schema.org/hasRepresentation','schema:hasRepresentation','hasRepresentation'],
        ['https://schema.org/depiction','http://schema.org/depiction','schema:depiction','depiction']
      ];
      for (const props of propsList) {
        const val = getFirstProp(node, props);
        if (!val) continue;
        const url = extractUrlFromImage(val, origin, graphMap);
        if (url) return url;
      }
      return '';
    }

    // === Onlim-Auflösung ===
    function isOnlimEntity(u) {
      try { const x = new URL(u); return /(^|\.)onlim\.com$/i.test(x.hostname) && /^\/entity\/[a-f0-9-]+$/i.test(x.pathname); }
      catch { return false; }
    }
    function parseOnlimIdNs(u) {
      const x = new URL(u);
      const id = x.pathname.split('/').pop();
      const ns = `${x.protocol}//${x.host}/entity`;
      return { id, ns };
    }
    function onlimCandidates(u) {
      const x = new URL(u);
      const id = x.pathname.split('/').pop();
      const base = `${x.protocol}//${x.host}`;
      const candidates = [
        `${base}/entity/${id}/download`,
        `${base}/entity/${id}?download=1`,
        `${base}/file/${id}`,
        `${base}/api/v1/entity/${id}/download`,
        `${base}/api/entity/${id}/download`,
        `${base}/api/file/${id}`
      ];
      return [...new Set(candidates)];
    }
    function toWeserv(urlStr) {
      try { const u = new URL(urlStr); const noScheme = `${u.host}${u.pathname}${u.search||''}`; return `https://images.weserv.nl/?url=${encodeURIComponent(noScheme)}&output=jpg`; }
      catch { return ''; }
    }
    async function resolveOnlimImage(rawUrl) {
      try {
        const { id, ns } = parseOnlimIdNs(rawUrl);
        const url = new URL(`https://proxy.opendatagermany.io/api/ts/v1/kg/things/${encodeURIComponent(id)}`);
        url.searchParams.set('ns', ns);
        const res = await fetch(url.toString(), {
          headers: { 'x-api-key': API_KEY, 'accept': 'application/json', 'inLang': 'de', 'x-hop': '0' }
        });
        if (!res.ok) return '';
        const data = await res.json();
        const arr = Array.isArray(data) ? data
                  : Array.isArray(data?.['@graph']) ? data['@graph']
                  : data ? [data] : [];
        const node = arr.find(n => n && typeof n==='object') || {};
        const origin = (() => { try { const u = new URL(rawUrl); return `${u.protocol}//${u.host}`; } catch { return ''; } })();
        const direct = extractUrlFromImage(node, origin, null);
        return direct || '';
      } catch { return ''; }
    }
    async function tryLoadImageChain(thumbEl, altText, rawUrl) {
      let resolved = '';
      if (isOnlimEntity(rawUrl)) {
        resolved = await resolveOnlimImage(rawUrl);
      }
      const baseList = isOnlimEntity(rawUrl) ? onlimCandidates(rawUrl) : [rawUrl];
      const list = resolved ? [resolved, ...baseList] : baseList;

      const attempts = [];
      for (const c of list) {
        attempts.push({ url: toWeserv(c) });
        attempts.push({ url: c.startsWith('http:') ? ('https:' + c.slice(5)) : c });
      }
      function attempt(idx=0) {
        if (idx >= attempts.length) {
          thumbEl.innerHTML = `<a href="${resolved || rawUrl}" target="_blank" rel="noopener">Bild öffnen</a>`;
          return;
        }
        const { url } = attempts[idx];
        const img = new Image();
        img.alt = altText || 'Bild'; img.loading = 'lazy'; img.decoding = 'async'; img.referrerPolicy = 'no-referrer';
        img.onload = () => { thumbEl.innerHTML = ''; thumbEl.appendChild(img); };
        img.onerror = () => attempt(idx+1);
        img.src = url;
      }
      attempt(0);
    }

    // ==== API Calls ====
    async function queryThings({ kw }) {
      const url = new URL('https://proxy.opendatagermany.io/api/ts/v2/kg/things');
      if (kw) url.searchParams.set('kw', kw);
      url.searchParams.set('filterDsList', DS_LIST_URL);

      const res = await fetch(url.toString(), {
        headers: {
          'x-api-key': API_KEY,
          'accept': 'application/json',
          'inLang': FIXED_LANG,
          'page': String(page),
          'page-size': String(PAGE_SIZE)
        }
      });
      if (!res.ok) throw new Error(`Suche fehlgeschlagen (${res.status})`);
      const data = await res.json();
      const items = Array.isArray(data) ? data
        : Array.isArray(data?.data) ? data.data
        : Array.isArray(data?.items) ? data.items
        : Array.isArray(data?.results) ? data.results
        : [];
      return items;
    }

    async function fetchThingById(uri) {
      if (!uri) return null;
      const lastSlash = Math.max(uri.lastIndexOf('/'), uri.lastIndexOf('#'));
      const ns = uri.substring(0, lastSlash);
      const id = uri.substring(lastSlash + 1);
      const url = new URL(`https://proxy.opendatagermany.io/api/ts/v1/kg/things/${encodeURIComponent(id)}`);
      url.searchParams.set('ns', ns);
      const res = await fetch(url.toString(), {
        headers: { 'x-api-key': API_KEY, 'accept': 'application/json', 'inLang': 'de', 'x-hop': '3' }
      });
      if (!res.ok) throw new Error(`Abruf fehlgeschlagen (${res.status})`);
      const data = await res.json();
      return { uri, data };
    }

    // ==== Suche ====
    async function search(query) {
      results.innerHTML = '';
      status(`<span class="spinner"></span> Lädt…`);
      prevBtn.disabled = true; nextBtn.disabled = true; countEl.textContent = '';

      try {
        let things = await queryThings({ kw: query });
        if (!things.length && query) { things = await queryThings({ kw: query }); }

        if (!things.length) { status('Keine Treffer. Begriff ändern.'); return; }

        const detailed = await Promise.all(things.map(t => fetchThingById(t['@id']).catch(() => null)));
        detailed.filter(Boolean).forEach(renderItem);

        status(`${things.length} Treffer.`);
        prevBtn.disabled = page === 1;
        nextBtn.disabled = things.length < PAGE_SIZE;
        countEl.textContent = `Seite ${page}`;
      } catch (err) {
        console.error(err);
        status(err.message || 'Unerwarteter Fehler', true);
      }
    }

    // ==== Rendering ====
    function renderItem(entry) {
      const { uri, data } = entry;
      const node = selectPrimaryNode(data, uri) || data || {};
      const graphMap = indexGraph(data);
      const el = tpl.content.firstElementChild.cloneNode(true);

      // Titel
      const nameVal = getFirstProp(node, ['https://schema.org/name','http://schema.org/name','schema:name','name','rdfs:label']);
      const name = pickLangString(nameVal) || fallbackTitleFromUri(uri);
      el.querySelector('[data-role=title]').textContent = name || 'Ohne Titel';

      // Kategorie
      let cat = '';
      const typesNode = Array.isArray(node['@type']) ? node['@type'] : (node['@type'] ? [node['@type']] : []);
      if (typesNode.length) {
        cat = typesNode.map(t => (typeof t === 'string' ? t : (t['@id'] || '')))
                       .map(t => t.split(/[#/]/).pop())
                       .filter(Boolean).join(', ');
      }
      if (!cat) {
        const catVal = getFirstProp(node, ['https://schema.org/category','http://schema.org/category','schema:category','category']);
        const picked = pickLangString(catVal);
        cat = Array.isArray(picked) ? picked.join(', ') : picked;
      }
      el.querySelector('[data-role=cat]').textContent = cat || '—';

      // Bild
      const rawImg = pickImageUrl(node, uri, graphMap);
      const thumb = el.querySelector('[data-role=thumb]');
      if (rawImg) { tryLoadImageChain(thumb, name || 'Bild', rawImg); }

      // Link
      const a = el.querySelector('[data-role=id]');
      a.href = uri; a.textContent = uri;

      results.appendChild(el);
    }
  </script>
</body>
</html>
